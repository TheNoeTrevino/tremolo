#!/bin/sh

if git diff --cached --name-only | grep -q "^frontend/"; then
  echo "üßπ Running Prettier on frontend files..."
  cd frontend && npx lint-staged
fi

if git diff --cached --name-only | grep -q "^backend/music/"; then
  echo "üêç Checking Python code formatting..."

  # Get staged Python files before changing directory
  STAGED_PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "^backend/music/.*\.py$")

  if [ -n "$STAGED_PY_FILES" ]; then
    cd backend/music

    if [ -f "env/bin/activate" ]; then
      . env/bin/activate

      # Remove the backend/music/ prefix from file paths
      STAGED_PY_FILES=$(echo "$STAGED_PY_FILES" | sed 's|^backend/music/||')

      echo "Running Black on staged Python files..."
      black $STAGED_PY_FILES

      if [ $? -ne 0 ]; then
        echo "‚ùå Black formatting failed."
        exit 1
      fi

      echo "Running flake8 on staged Python files..."
      flake8 $STAGED_PY_FILES --select=E9,F63,F7,F82

      if [ $? -ne 0 ]; then
        echo "‚ùå Flake8 found critical errors."
        exit 1
      fi

      # Re-stage the formatted files
      cd ../..
      for file in $STAGED_PY_FILES; do
        git add "backend/music/$file"
      done

      echo "‚úÖ Python code checks passed!"
    else
      echo "‚ö†Ô∏è  Virtual environment not found. Skipping Python checks."
      echo "    Run: cd backend/music && python3 -m venv env && source env/bin/activate && pip install -r requirements.txt"
    fi
  fi
fi
