name: Move issue to "Code Review" when PR is opened

on:
  pull_request:
    types: [opened]
    branches:
      - main

jobs:
  move_to_code_review:
    runs-on: ubuntu-latest
    steps:
      - name: Move linked issues to Code Review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            // search both title and body
            const textToSearch = `${pr.title || ''} ${pr.body || ''}`;
            const issueRefs = textToSearch.match(/#(\d+)/g) || [];

            const PROJECT_ID = "PVT_kwHOCJZzqc4AoJ-p";
            const STATUS_FIELD_ID = "PVTSSF_lAHOCJZzqc4AoJ-pzgfxfns";
            const CODE_REVIEW_OPTION_ID = "6934889d";

            console.log(`Found ${issueRefs.length} issue references in PR body`);

            for (const ref of issueRefs) {
              const issueNumber = parseInt(ref.replace("#", ""));
              console.log(`Processing issue #${issueNumber}`);
              
              try {
                // Get the issue node ID
                const issue = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber
                });
                
                console.log(`Issue #${issueNumber} node_id: ${issue.data.node_id}`);
                
                // Find the project item ID for this issue
                const projectItemQuery = `
                  query($issueId: ID!) {
                    node(id: $issueId) {
                      ... on Issue {
                        projectItems(first: 10) {
                          nodes {
                            id
                            project {
                              id
                            }
                          }
                        }
                      }
                    }
                  }
                `;
                
                const projectItemResult = await github.graphql(projectItemQuery, {
                  issueId: issue.data.node_id
                });
                
                console.log(`Project items for issue #${issueNumber}:`, JSON.stringify(projectItemResult.node.projectItems, null, 2));
                
                const projectItem = projectItemResult.node.projectItems.nodes.find(
                  item => item.project.id === PROJECT_ID
                );
                
                if (!projectItem) {
                  console.log(`Issue #${issueNumber} is not in the Tremolonotes project, skipping`);
                  continue;
                }
                
                console.log(`Found project item ID: ${projectItem.id}`);
                
                // Update the project item status to "Code Review"
                const updateMutation = `
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                    updateProjectV2ItemFieldValue(
                      input: {
                        projectId: $projectId
                        itemId: $itemId
                        fieldId: $fieldId
                        value: { singleSelectOptionId: $optionId }
                      }
                    ) {
                      projectV2Item {
                        id
                      }
                    }
                  }
                `;
                
                await github.graphql(updateMutation, {
                  projectId: PROJECT_ID,
                  itemId: projectItem.id,
                  fieldId: STATUS_FIELD_ID,
                  optionId: CODE_REVIEW_OPTION_ID
                });
                
                console.log(`âœ… Successfully moved issue #${issueNumber} to Code Review`);
                
              } catch (error) {
                console.error(`Error processing issue #${issueNumber}:`, error.message);
              }
            }
